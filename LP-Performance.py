import streamlit as st
import pandas as pd
import pydeck as pdk
import re

# ===============================
# üß≠ APP KONFIGURATION
# ===============================
st.set_page_config(
    page_title="LP-Tool Dashboard",
    layout="wide",
    page_icon="üîã",
    initial_sidebar_state="expanded"
)

st.title("üîã LP-Tool Dashboard ‚Äì Standortanalyse & Heatmap")
st.markdown("Diese App liest Excel-Dateien mit Monatswerten pro Ladepunkt und erstellt Diagramme und eine geografische Heatmap.")

# ===============================
# ‚öôÔ∏è CACHING F√úR MONATSDATEN
# ===============================
@st.cache_data(show_spinner=True)
def load_excel(file):
    expected_cols = ["Steuerger√§t ID", "EVSE-ID", "Ist in kWh", "YTD-Summe", "YTD-Schnitt (pro Monat)"]
    raw = pd.read_excel(file, header=None)
    header_row_index = raw[raw.apply(lambda row: all(col in row.values for col in expected_cols), axis=1)].index
    if not header_row_index.empty:
        header_row = header_row_index[0]
        df = pd.read_excel(file, header=header_row)
        return df
    else:
        st.error("Der erwartete Header wurde in der ersten Excel-Datei nicht gefunden.")
        return pd.DataFrame()

@st.cache_data(show_spinner=True)
def transform_monthly_data(df):
    df["Standort"] = df["Ist in kWh"].fillna(method="ffill")
    df = df.rename(columns={"Steuerger√§t ID": "Steuerger√§t", "EVSE-ID": "EVSE", "YTD-Summe": "YTD_Summe", "YTD-Schnitt (pro Monat)": "YTD_Schnitt"})
    month_order = ["Januar", "Februar", "M√§rz", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"]
    id_cols = ["Standort", "Steuerger√§t", "EVSE", "YTD_Summe", "YTD_Schnitt"]
    df_long = df.melt(id_vars=id_cols, value_vars=[c for c in month_order if c in df.columns], var_name="Monat", value_name="Energiemenge")
    df_long["Energiemenge"] = pd.to_numeric(df_long["Energiemenge"], errors="coerce")
    df_long = df_long.dropna(subset=["Energiemenge"])
    df_long["Monat"] = pd.Categorical(df_long["Monat"], categories=month_order, ordered=True)
    df_long = df_long.sort_values(["Standort", "Monat"])
    return df_long

# ===============================
# ‚öôÔ∏è DEBUG-VERSION DER GEO-FUNKTION
# ===============================
@st.cache_data(show_spinner=True)
def load_geo_excel_debug(file):
    st.info("DEBUG-MODUS: Starte Einlesen der Geo-Datei...")
    
    raw = pd.read_excel(file, header=None)
    header_row_index = -1
    for i in range(min(10, len(raw))):
        if any(pd.notna(val) for val in raw.iloc[i, 1:].values):
            header_row_index = i
            st.info(f"DEBUG: Header-Zeile mit Standortnamen in Zeile {i+1} der Excel-Datei gefunden.")
            break
            
    if header_row_index == -1:
        st.error("DEBUG-FEHLER: Konnte keine Header-Zeile (mit Standorten ab Spalte B) finden. Abbruch.")
        return pd.DataFrame()

    standort_namen = raw.iloc[header_row_index, 1:].tolist()
    data_df = raw.iloc[header_row_index + 1:].reset_index(drop=True)
    labels = data_df.iloc[:, 0].astype(str).str.strip()
    geo_records = []
    
    st.info(f"DEBUG: {len(standort_namen)} Standorte (Spalten) werden verarbeitet.")

    for col_idx, standort_name in enumerate(standort_namen, start=1):
        if pd.isna(standort_name) or col_idx >= len(data_df.columns): continue
        
        st.markdown(f"--- \n ### DEBUG: Verarbeite Standort: `{standort_name}`")
        col_values = data_df.iloc[:, col_idx]
        current_steuerger√§t, ladepunkte, laengengrad, breitengrad = None, [], None, None

        for i, val in enumerate(col_values):
            if pd.isna(val) or i >= len(labels): continue
            val_str, label = str(val).strip(), labels[i]

            if label == "Steuerger√§t" and val_str:
                if current_steuerger√§t:
                    st.warning(f"DEBUG: Pr√ºfe vorherigen Block '{current_steuerger√§t}'...")
                    is_complete = True
                    if not ladepunkte: is_complete = False; st.error("   - FEHLER: Keine EVSE-IDs gefunden.")
                    if laengengrad is None: is_complete = False; st.error("   - FEHLER: L√§ngengrad fehlt.")
                    if breitengrad is None: is_complete = False; st.error("   - FEHLER: Breitengrad fehlt.")
                    
                    if is_complete:
                        st.success(f"   -> Block '{current_steuerger√§t}' ist vollst√§ndig und wird gespeichert.")
                        for lp in ladepunkte: geo_records.append({"Standort": str(standort_name), "Steuerger√§t": current_steuerger√§t, "EVSE-ID": lp, "L√§ngengrad": laengengrad, "Breitengrad": breitengrad})
                    else:
                        st.error(f"   -> Block '{current_steuerger√§t}' ist unvollst√§ndig und wird VERWORFEN.")
                
                st.info(f"DEBUG: Neuer Block f√ºr Steuerger√§t '{val_str}' gestartet.")
                current_steuerger√§t, ladepunkte, laengengrad, breitengrad = val_str, [], None, None
                continue

            if label == "EVSE-ID":
                if re.match(r"DE\*ARK\*E\d{5}\*\d{3}", val_str, re.IGNORECASE):
                    ladepunkte.append(val_str)
                else: 
                    st.warning(f"DEBUG: Ignoriere EVSE-ID '{val_str}', da sie nicht dem erwarteten Format entspricht.")
            elif label == "L√§ngengrad" and val_str:
                try: laengengrad = float(re.findall(r"[-+]?\d*\.\d+|\d+", val_str.replace(",", ".").replace("¬∞", "").strip())[0])
                except (ValueError, IndexError): laengengrad = None
            elif label == "Breitengrad" and val_str:
                try: breitengrad = float(re.findall(r"[-+]?\d*\.\d+|\d+", val_str.replace(",", ".").replace("¬∞", "").strip())[0])
                except (ValueError, IndexError): breitengrad = None

        if current_steuerger√§t:
            st.warning(f"DEBUG: Pr√ºfe letzten Block '{current_steuerger√§t}' in Spalte '{standort_name}'...")
            is_complete = True
            if not ladepunkte: is_complete = False; st.error("   - FEHLER: Keine EVSE-IDs gefunden.")
            if laengengrad is None: is_complete = False; st.error("   - FEHLER: L√§ngengrad fehlt.")
            if breitengrad is None: is_complete = False; st.error("   - FEHLER: Breitengrad fehlt.")

            if is_complete:
                st.success(f"   -> Letzter Block '{current_steuerger√§t}' ist vollst√§ndig und wird gespeichert.")
                for lp in ladepunkte: geo_records.append({"Standort": str(standort_name), "Steuerger√§t": current_steuerger√§t, "EVSE-ID": lp, "L√§ngengrad": laengengrad, "Breitengrad": breitengrad})
            else:
                st.error(f"   -> Letzter Block '{current_steuerger√§t}' ist unvollst√§ndig und wird VERWORFEN.")
    
    st.markdown("---")
    st.info(f"DEBUG-ZUSAMMENFASSUNG: {len(geo_records)} g√ºltige Datens√§tze vor der Endpr√ºfung gefunden.")
    geo_df = pd.DataFrame(geo_records)
    if not geo_df.empty:
        cleaned_df = geo_df.dropna(subset=["Breitengrad", "L√§ngengrad"])
        st.info(f"DEBUG: Nach der Endpr√ºfung bleiben {len(cleaned_df)} Datens√§tze √ºbrig.")
        return cleaned_df
    
    st.error("DEBUG-ERGEBNIS: Die Funktion gibt eine leere Tabelle zur√ºck.")
    return geo_df

# ===============================
# üìÇ SIDEBAR: Datei-Uploads
# ===============================
st.sidebar.header("üìÇ Datenquellen")
uploaded_file_1 = st.sidebar.file_uploader("Lade Monatsdaten (Test LP-Tool.xlsx)", type=["xlsx"], key="file1")
uploaded_file_2 = st.sidebar.file_uploader("Lade Geokoordinaten (LS-Geokoordinaten.xlsx)", type=["xlsx"], key="file2")

# ===============================
# üìà ANZEIGE DER MONATSDATEN
# ===============================
df_data = None
if uploaded_file_1:
    df_raw = load_excel(uploaded_file_1)
    if not df_raw.empty:
        df_data = transform_monthly_data(df_raw)
        st.subheader("üìä Bereinigte Monatswerte je Standort")
        st.dataframe(df_data.head(20), use_container_width=True)
        standorte = sorted(df_data["Standort"].dropna().unique())
        if standorte:
            selected_standort = st.selectbox("Standort ausw√§hlen:", standorte)
            df_filtered = df_data[df_data["Standort"] == selected_standort]
            st.markdown(f"**Anzahl Ladepunkte:** {df_filtered['EVSE'].nunique()} | **Steuerger√§te:** {df_filtered['Steuerger√§t'].nunique()}")
            df_chart = df_filtered.groupby("Monat")["Energiemenge"].sum().reset_index()
            st.bar_chart(df_chart, x="Monat", y="Energiemenge", use_container_width=True)
else:
    st.info("Bitte zuerst die Datei **Test LP-Tool.xlsx** hochladen.")

# ===============================
# üó∫Ô∏è HEATMAP
# ===============================
if df_data is not None and uploaded_file_2:
    # HIER WIRD DIE DEBUG-FUNKTION AUFGERUFEN
    df_geo = load_geo_excel_debug(uploaded_file_2)
    
    st.header("üåç Standort-Heatmap")

    if not df_geo.empty:
        time_options = ["Gesamtzeit"] + df_data['Monat'].unique().tolist()
        selected_timespan = st.selectbox("Zeitraum f√ºr Heatmap ausw√§hlen:", time_options)

        if selected_timespan == "Gesamtzeit":
            st.subheader("Gesamtenergiemenge aller Monate")
            df_sum = df_data.groupby("Standort")["Energiemenge"].sum().reset_index()
        else:
            st.subheader(f"Energiemenge im {selected_timespan}")
            df_monthly = df_data[df_data["Monat"] == selected_timespan]
            df_sum = df_monthly.groupby("Standort")["Energiemenge"].sum().reset_index()

        df_geo_unique = df_geo.groupby("Standort")[["Breitengrad", "L√§ngengrad"]].first().reset_index()
        df_merged = pd.merge(df_sum, df_geo_unique, on="Standort", how="inner")

        if not df_merged.empty:
            st.pydeck_chart(pdk.Deck(
                map_style="mapbox://styles/mapbox/light-v9",
                initial_view_state=pdk.ViewState(latitude=df_merged["Breitengrad"].mean(), longitude=df_merged["L√§ngengrad"].mean(), zoom=6, pitch=0),
                layers=[
                    pdk.Layer("HeatmapLayer", data=df_merged, get_position='[L√§ngengrad, Breitengrad]', get_weight="Energiemenge", radiusPixels=60, aggregation=pdk.types.String("SUM")),
                    pdk.Layer("ScatterplotLayer", data=df_merged, get_position='[L√§ngengrad, Breitengrad]', get_radius=3000, get_fill_color='[255, 0, 0, 160]', pickable=True)
                ],
                tooltip={"html": "<b>Standort:</b> {Standort} <br/> <b>Energiemenge:</b> {Energiemenge} kWh", "style": {"backgroundColor": "steelblue", "color": "white"}}
            ))
        else:
            st.warning(f"Keine √ºbereinstimmenden Standorte mit Energiedaten f√ºr den Zeitraum '{selected_timespan}' gefunden.")
    else:
        st.warning("Die hochgeladene Geo-Datei enth√§lt keine g√ºltigen oder auslesbaren Koordinaten. Bitte pr√ºfen Sie die DEBUG-Meldungen oben.")
